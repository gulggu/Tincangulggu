<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>깡갤 글꾸 변환기</title>
    <script src="https://cdn.jsdelivr.net/npm/@jaames/iro@5"></script>
    <style>
        body {
            font-family: 'Nanum Myeongjo', serif;
            text-align: center;
            background-color: #f4f4f4;
            padding: 20px;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
        }
        .controls-section {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            margin: 20px 0;
            gap: 20px;
        }
        .control-group {
            flex: 1;
            min-width: 300px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .header-section {
            margin-bottom: 20px;
        }
        #color-picker {
            margin: 15px auto;
        }
        canvas {
            border: 1px solid #ddd;
            margin: 10px auto;
            max-width: 100%;
            box-shadow: 0 3px 6px rgba(0,0,0,0.1);
        }
        textarea {
            width: 100%;
            height: 150px;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: 'Nanum Myeongjo', serif;
            resize: vertical;
        }
        .btn {
            background-color: #4CAF50;
            border: none;
            color: white;
            padding: 10px 20px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            margin: 10px 5px;
            cursor: pointer;
            border-radius: 4px;
            transition: background-color 0.3s;
        }
        .btn:hover {
            background-color: #45a049;
        }
        .btn-download {
            background-color: #2196F3;
        }
        .btn-download:hover {
            background-color: #0b7dda;
        }
        .image-container {
            display: none;
            margin: 20px 0;
        }
        .color-options {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 15px 0;
        }
        .color-option {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid transparent;
        }
        .color-option.selected {
            border: 2px solid black;
        }
        .number-input {
            margin: 10px 0;
        }
        label {
            display: block;
            margin: 10px 0 5px;
            font-weight: bold;
            text-align: left;
        }
        #header-image-preview {
            max-width: 100%;
            max-height: 200px;
            margin: 10px 0;
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>텍스트 → 이미지 변환기</h1>
        
        <div class="controls-section">
            <div class="control-group">
                <h2>이미지 설정</h2>
                
                <!-- 헤더 이미지 선택 -->
                <div class="header-section">
                    <label for="header-image">헤더 이미지 선택:</label>
                    <input type="file" id="header-image" accept="image/*">
                    <img id="header-image-preview" alt="헤더 이미지 미리보기">
                </div>
                
                <!-- 배경색 설정 -->
                <label>배경색 선택:</label>
                <div class="color-options">
                    <div class="color-option selected" style="background-color: #FFD700;" data-color="#FFD700"></div>
                    <div class="color-option" style="background-color: #E6E6E6;" data-color="#E6E6E6"></div>
                    <div class="color-option" style="background-color: #ADD8E6;" data-color="#ADD8E6"></div>
                    <div class="color-option" style="background-color: #98FB98;" data-color="#98FB98"></div>
                    <div class="color-option" style="background-color: #FFC0CB;" data-color="#FFC0CB"></div>
                </div>
                
                <!-- 색상 선택기 -->
                <div id="color-picker"></div>
                <input type="hidden" id="selected-color" value="#FFD700">
                
                <!-- 이미지 번호 설정 -->
                <div class="number-input">
                    <label for="image-number">이미지 번호:</label>
                    <input type="number" id="image-number" min="1" value="1" style="width: 100px;">
                </div>
            </div>
            
            <div class="control-group">
                <!-- 텍스트 입력 -->
                <h2>텍스트 설정</h2>
                <label for="user-text">텍스트 입력:</label>
                <textarea id="user-text" placeholder="이미지에 들어갈 텍스트를 입력하세요."></textarea>
                
                <!-- 텍스트 스타일 설정 -->
                <label for="font-size">텍스트 크기:</label>
                <select id="font-size">
                    <option value="16">작게</option>
                    <option value="20" selected>기본</option>
                    <option value="24">크게</option>
                </select>
                
                <label for="line-height">줄 간격:</label>
                <select id="line-height">
                    <option value="1.3">좁게</option>
                    <option value="1.6" selected>기본</option>
                    <option value="2.0">넓게</option>
                </select>
            </div>
        </div>
        
        <!-- 이미지 생성 버튼 -->
        <button id="generate-btn" class="btn">이미지 생성</button>
        
        <!-- 미리보기 캔버스 -->
        <h3>미리보기</h3>
        <canvas id="preview-canvas" width="800" height="800"></canvas>
        
        <!-- 결과 이미지 섹션 -->
        <div class="image-container">
            <h3>생성된 이미지</h3>
            <div id="pages-container"></div>
            <button id="download-all-btn" class="btn btn-download">모든 이미지 다운로드 (ZIP)</button>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    
    <script>
        // 전역 변수
        let headerImage = null;
        let canvasPages = [];
        
        // 색상 선택기 설정
        const colorPicker = new iro.ColorPicker("#color-picker", {
            width: 200,
            color: "#FFD700", // 기본 색상 (노랑)
            layout: [
                { component: iro.ui.Wheel }
            ]
        });

        // 선택된 색상을 hidden input에 저장
        colorPicker.on("color:change", function(color) {
            document.getElementById("selected-color").value = color.hexString;
            document.querySelectorAll('.color-option').forEach(option => {
                option.classList.remove('selected');
            });
            updatePreview();
        });
        
        // 색상 옵션 이벤트 리스너
        document.querySelectorAll('.color-option').forEach(option => {
            option.addEventListener('click', function() {
                document.querySelectorAll('.color-option').forEach(opt => {
                    opt.classList.remove('selected');
                });
                this.classList.add('selected');
                const color = this.getAttribute('data-color');
                document.getElementById("selected-color").value = color;
                colorPicker.color.hexString = color;
                updatePreview();
            });
        });
        
        // 헤더 이미지 변경 이벤트
        document.getElementById('header-image').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    const img = new Image();
                    img.onload = function() {
                        headerImage = img;
                        document.getElementById('header-image-preview').src = event.target.result;
                        document.getElementById('header-image-preview').style.display = 'block';
                        updatePreview();
                    };
                    img.src = event.target.result;
                };
                reader.readAsDataURL(file);
            }
        });

        // 텍스트 입력 이벤트
        document.getElementById('user-text').addEventListener('input', updatePreview);
        document.getElementById('font-size').addEventListener('change', updatePreview);
        document.getElementById('line-height').addEventListener('change', updatePreview);
        document.getElementById('image-number').addEventListener('input', updatePreview);

        // 미리보기 업데이트 함수
        function updatePreview() {
            const canvas = document.getElementById("preview-canvas");
            const ctx = canvas.getContext("2d");
            const selectedColor = document.getElementById("selected-color").value;
            const userText = document.getElementById("user-text").value || "미리보기 텍스트";
            const imageNumber = document.getElementById("image-number").value || "1";
            const fontSize = document.getElementById("font-size").value;
            const lineHeight = document.getElementById("line-height").value;
            
            // 캔버스 초기화
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // 배경색 설정
            ctx.fillStyle = selectedColor;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // 헤더 이미지 그리기
            if (headerImage) {
                const aspectRatio = headerImage.width / headerImage.height;
                const headerHeight = 300;
                const headerWidth = headerHeight * aspectRatio;
                
                ctx.drawImage(
                    headerImage, 
                    (canvas.width - headerWidth) / 2, 
                    0, 
                    headerWidth, 
                    headerHeight
                );
                
                // 이미지 번호 그리기
                ctx.font = "italic 36px 'Times New Roman'";
                ctx.fillStyle = "black";
                ctx.textAlign = "center";
                ctx.fillText(`No. ${imageNumber.padStart(2, '0')}`, canvas.width / 2, headerHeight + 80);
            } else {
                // 이미지 번호만 그리기
                ctx.font = "italic 36px 'Times New Roman'";
                ctx.fillStyle = "black";
                ctx.textAlign = "center";
                ctx.fillText(`No. ${imageNumber.padStart(2, '0')}`, canvas.width / 2, 80);
            }
            
            // 텍스트 렌더링
            renderText(ctx, userText, canvas.width, canvas.height, fontSize, lineHeight, headerImage ? 400 : 120);
            
            // 페이지 번호 그리기
            ctx.font = "bold 16px Arial";
            ctx.fillStyle = "black";
            ctx.textAlign = "center";
            ctx.fillText("1", canvas.width / 2, canvas.height - 20);
        }
        
        // 텍스트 렌더링 함수
        function renderText(ctx, text, canvasWidth, canvasHeight, fontSize, lineHeight, startY) {
            const maxWidth = canvasWidth - 100; // 좌우 50px 여백
            ctx.font = `${fontSize}px 'Nanum Myeongjo', serif`;
            ctx.fillStyle = "black";
            ctx.textAlign = "left";
            
            const words = text.split(' ');
            const paragraphs = text.split('\n');
            
            let y = startY;
            
            paragraphs.forEach(paragraph => {
                if (paragraph.trim() === '') {
                    y += parseInt(fontSize) * parseFloat(lineHeight);
                    return;
                }
                
                const lines = getLines(ctx, paragraph, maxWidth);
                
                lines.forEach(line => {
                    ctx.fillText(line, 50, y);
                    y += parseInt(fontSize) * parseFloat(lineHeight);
                });
                
                // 단락 사이 추가 공간
                y += parseInt(fontSize) * 0.5;
            });
        }
        
        // 텍스트를 여러 줄로 나누는 함수
        function getLines(ctx, text, maxWidth) {
            const words = text.split(' ');
            const lines = [];
            let currentLine = words[0];

            for (let i = 1; i < words.length; i++) {
                const word = words[i];
                const width = ctx.measureText(currentLine + ' ' + word).width;
                
                if (width < maxWidth) {
                    currentLine += ' ' + word;
                } else {
                    lines.push(currentLine);
                    currentLine = word;
                }
            }
            
            lines.push(currentLine);
            return lines;
        }
        
        // 이미지 생성 및 페이지 나누기
        document.getElementById('generate-btn').addEventListener('click', function() {
            const userText = document.getElementById('user-text').value;
            if (!userText) {
                alert('텍스트를 입력해주세요.');
                return;
            }
            
            const imageNumber = parseInt(document.getElementById('image-number').value);
            const fontSize = document.getElementById('font-size').value;
            const lineHeight = document.getElementById('line-height').value;
            const selectedColor = document.getElementById('selected-color').value;
            
            // 텍스트 분량에 따라 페이지 나누기
            const pageHeight = 800;
            const textStartY = headerImage ? 400 : 120;
            const linesPerPage = Math.floor((pageHeight - textStartY - 50) / (parseInt(fontSize) * parseFloat(lineHeight)));
            
            // 먼저 몇 페이지가 필요한지 계산
            const tempCanvas = document.createElement('canvas');
            const tempCtx = tempCanvas.getContext('2d');
            tempCanvas.width = 800;
            tempCanvas.height = 800;
            tempCtx.font = `${fontSize}px 'Nanum Myeongjo', serif`;
            
            const paragraphs = userText.split('\n');
            let totalLines = 0;
            
            paragraphs.forEach(paragraph => {
                if (paragraph.trim() === '') {
                    totalLines += 1;
                    return;
                }
                
                const lines = getLines(tempCtx, paragraph, 700);
                totalLines += lines.length + 0.5; // 단락 사이 추가 공간
            });
            
            const totalPages = Math.ceil(totalLines / linesPerPage);
            
            // 페이지 생성
            canvasPages = [];
            let pagesContainer = document.getElementById('pages-container');
            pagesContainer.innerHTML = '';
            
            // 각 페이지 생성
            for (let page = 0; page < totalPages; page++) {
                const pageCanvas = document.createElement('canvas');
                pageCanvas.width = 800;
                pageCanvas.height = 800;
                const pageCtx = pageCanvas.getContext('2d');
                
                // 배경 설정
                pageCtx.fillStyle = selectedColor;
                pageCtx.fillRect(0, 0, pageCanvas.width, pageCanvas.height);
                
                // 헤더 이미지 (첫 페이지만)
                if (page === 0 && headerImage) {
                    const aspectRatio = headerImage.width / headerImage.height;
                    const headerHeight = 300;
                    const headerWidth = headerHeight * aspectRatio;
                    
                    pageCtx.drawImage(
                        headerImage, 
                        (pageCanvas.width - headerWidth) / 2, 
                        0, 
                        headerWidth, 
                        headerHeight
                    );
                }
                
                // 이미지 번호 그리기 (첫 페이지만)
                if (page === 0) {
                    pageCtx.font = "italic 36px 'Times New Roman'";
                    pageCtx.fillStyle = "black";
                    pageCtx.textAlign = "center";
                    const numY = headerImage ? 350 : 80;
                    pageCtx.fillText(`No. ${imageNumber.toString().padStart(2, '0')}`, pageCanvas.width / 2, numY);
                }
                
                // 텍스트 분할 및 렌더링
                const startLine = page * linesPerPage;
                const endLine = Math.min((page + 1) * linesPerPage, totalLines);
                renderPageText(pageCtx, userText, startLine, endLine, pageCanvas.width, pageCanvas.height, fontSize, lineHeight, page === 0 ? textStartY : 50);
                
                // 페이지 번호
                pageCtx.font = "bold 16px Arial";
                pageCtx.fillStyle = "black";
                pageCtx.textAlign = "center";
                pageCtx.fillText((page + 1).toString(), pageCanvas.width / 2, pageCanvas.height - 20);
                
                // 캔버스 저장 및 표시
                canvasPages.push(pageCanvas);
                
                // 이미지로 변환하여 표시
                const img = document.createElement('img');
                img.src = pageCanvas.toDataURL('image/png');
                img.style.maxWidth = '100%';
                img.style.margin = '10px 0';
                img.style.boxShadow = '0 3px 6px rgba(0,0,0,0.1)';
                
                const downloadBtn = document.createElement('button');
                downloadBtn.textContent = `페이지 ${page + 1} 다운로드`;
                downloadBtn.className = 'btn btn-download';
                downloadBtn.style.display = 'block';
                downloadBtn.style.margin = '5px auto 20px';
                
                downloadBtn.addEventListener('click', function() {
                    const link = document.createElement('a');
                    link.download = `image_${imageNumber}_page_${page + 1}.png`;
                    link.href = img.src;
                    link.click();
                });
                
                pagesContainer.appendChild(img);
                pagesContainer.appendChild(downloadBtn);
            }
            
            document.querySelector('.image-container').style.display = 'block';
        });
        
        // 페이지별 텍스트 렌더링
        function renderPageText(ctx, fullText, startLine, endLine, canvasWidth, canvasHeight, fontSize, lineHeight, startY) {
            const maxWidth = canvasWidth - 100; // 좌우 50px 여백
            ctx.font = `${fontSize}px 'Nanum Myeongjo', serif`;
            ctx.fillStyle = "black";
            ctx.textAlign = "left";
            
            const paragraphs = fullText.split('\n');
            let lineCount = 0;
            let currentY = startY;
            
            for (let i = 0; i < paragraphs.length; i++) {
                const paragraph = paragraphs[i];
                
                if (paragraph.trim() === '') {
                    lineCount++;
                    if (lineCount > endLine) break;
                    if (lineCount >= startLine && lineCount < endLine) {
                        currentY += parseInt(fontSize) * parseFloat(lineHeight);
                    }
                    continue;
                }
                
                const lines = getLines(ctx, paragraph, maxWidth);
                
                for (let j = 0; j < lines.length; j++) {
                    lineCount++;
                    if (lineCount > endLine) break;
                    
                    if (lineCount >= startLine && lineCount < endLine) {
                        ctx.fillText(lines[j], 50, currentY);
                        currentY += parseInt(fontSize) * parseFloat(lineHeight);
                    }
                }
                
                // 단락 사이 추가 공간
                lineCount += 0.5;
                if (lineCount >= startLine && lineCount < endLine) {
                    currentY += parseInt(fontSize) * 0.5;
                }
            }
        }
        
        // 모든 이미지 다운로드 (ZIP)
        document.getElementById('download-all-btn').addEventListener('click', function() {
            if (canvasPages.length === 0) return;
            
            const zip = new JSZip();
            const imageNumber = document.getElementById('image-number').value;
            let counter = 0;
            let completed = 0;
            
            canvasPages.forEach((canvas, index) => {
                canvas.toBlob(function(blob) {
                    zip.file(`image_${imageNumber}_page_${index + 1}.png`, blob);
                    completed++;
                    
                    if (completed === canvasPages.length) {
                        zip.generateAsync({type: 'blob'}).then(function(content) {
                            saveAs(content, `images_${imageNumber}.zip`);
                        });
                    }
                });
            });
        });
        
        // 초기 미리보기 업데이트
        updatePreview();
    </script>
</body>
</html>
